---
title: "Stat 251 Homework 10"
author: "Taylor Grimm"
date: "11/11/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include=TRUE, fig.width=8, fig.height=4)
```

```{r}
library(invgamma)
gibbs_sampler_nnig <- function(data, m, v, a, b, iter=1e5){
  ybar <- mean(data)
  n <- length(data)
  mu <- numeric()
  sigma2 <- numeric()

  # Initial Values

  mu[1] <- ybar
  sigma2[1] <- var(data)
  
  for(j in 2:iter){
    # Start by updating mu
    vstar <- 1/( n / sigma2[j-1] + 1/v)
    mstar <- (m/v + ((n/sigma2[j-1]*ybar)))*vstar
  
    mu[j] <- rnorm(1, mstar, sqrt(vstar))
  
    # Now, update sigma2
    astar <- a + length(data)/2
    bstar <- b + (1/2)*sum((data - mu[j])^2)
    
    sigma2[j] <- rinvgamma(1, astar, bstar)
    
  }
  return(data.frame(mu=mu, sigma2=sigma2))
}


```
For all problems, I used a burn-in of 99 draws. All parameters appeared to converge with good mixing (from traceplots/acf plots), so those plots are not including below.

# 1.

```{r}
bp <- c(8, 12, 10, 14, 2, 0, 0)

m1 <- 6
v1 <- 32

a1 <- 3
b1 <- 50

draws_1 <- gibbs_sampler_nnig(data=bp, m=m1, v=v1, a=a1, b=b1)

# Good convergence and mixing
#plot(draws_1$mu, type='l')
#acf(draws_1$mu)

prob1a <- mean(draws_1$mu[100:1e5] > 0)
prob1b <- mean(draws_1$sigma2[100:1e5] > 30)

```

a) The posterior probability that $\mu$ is greater than 0 = `r prob1a`.

b) The posterior probability that $\sigma^2 > 30$ = `r prob1b`.

c)

```{r}
x1c <- seq(-20, 25, length=1000)
plot(x1c, dnorm(x1c, m1, sqrt(v1)), ylab="Density", xlab=expression(mu), type='l', ylim=c(0, 0.25), col='gray', main =expression(paste("Prior and Posterior Distributions of ", mu, sep='')))
lines(density(draws_1$mu[100:1e5]), col='black')
legend('topright', legend=c("Prior", "Posterior"), lty=1, col=c("gray", "black"))
```

d)

```{r}
x1d <- seq(0, 100, length=1000)
plot(x1d, dinvgamma(x1d, a1, b1), ylab="Density", xlab=expression(sigma^2), type='l', col='gray', main =expression(paste("Prior and Posterior Distributions of ", sigma^2, sep='')))
lines(density(draws_1$sigma2[100:1e5]), col='black')
legend('topright', legend=c("Prior", "Posterior"), lty=1, col=c("gray", "black"))

```


# 2.
```{r}
data_2 <- c(197, 199, 214, 217, 222, 223, 227, 228, 234)
m2 <- 180
v2 <- 10^2
a2 <- 2.1
b2 <- 480

draws_2 <- gibbs_sampler_nnig(data_2, m=m2, v=v2, a=a2, b=b2)

```


a)

```{r}
plot(density(draws_2$mu[100:1e5]), ylab="Density", xlab=expression(mu[urban]), main=expression(paste("Posterior Distribution of ", mu[urban], sep='')))

plot(density(draws_2$sigma2[100:1e5]), ylab="Density", xlab=expression(sigma^2), main=expression(paste("Posterior Distribution of ", sigma^2, sep='')), xlim=c(0,1000))

```

```{r}
prob2b <- mean(draws_2$sigma2[100:1e5])
prob2c <- mean(draws_2$mu[100:1e5])
```
b) The posterior expected value of $\sigma_{urban}^2$ = `r prob2b`.

c) The posterior expected value of $\mu_{urban}$ = `r prob2c`.

d)

```{r}
draws_2d <- gibbs_sampler_nnig(data=data_2, m=180, v=400, a=a2, b=b2)

plot(density(draws_2$mu[100:1e5]), ylab="Density", xlab=expression(mu[urban]), main=expression(paste("Posterior Distributions of ", mu[urban], sep='')), col='gray', ylim=c(0,0.1))
lines(density(draws_2d$mu[100:1e5]), col='black')
legend('topright', legend=c("Part a", "Part d"), lty=1, col=c("gray", "black"))

```



# 3.

```{r}
data_3 <- c(139, 142, 143, 144, 145, 148, 155, 162, 171, 181)

m3 <- 150
v3 <- 500
a3 <- 3
b3 <- 180

draws_3 <- gibbs_sampler_nnig(data_3, m=m3, v=v3, a=a3, b=b3)

plot(density(draws_3$mu[100:1e5]), ylab="Density", xlab=expression(mu[rural]), main=expression(paste("Posterior Distribution of ", mu[rural], sep='')))

```



# 4.

```{r}
diff4_mu <- draws_2$mu[100:1e5] - draws_3$mu[100:1e5]
ratio4_sigma2 <- draws_2$sigma2[100:1e5] / draws_3$sigma2[100:1e5]

prob4a_int <- quantile(diff4_mu, c(0.025, 0.975))
prob4b_int <- quantile(ratio4_sigma2, c(0.025, 0.975))
```

a) There is a 95% probability that the true value of $\mu_{urban} - \mu{rural}$ is between `r prob4a_int[1]` and `r prob4a_int[2]`. Since 0 is not in this interval, we can conclude that the average total serum cholesterol for urban residents of Guatemala is indeed greater than it is for rural residents of Guatemala.
```{r}
plot(density(diff4_mu), xlab=expression(mu[urban] - mu[rural]), ylab='Density', main=expression(paste("Posterior distribution of ", mu[urban] - mu[rural], sep='')))

```


b) There is a 95% probability that the true value of $\sigma_{urban}^2 / sugma_{rural}^2$ is between `r prob4b_int[1]` and `r prob4b_int[2]`. Since 1 is in this interval, we can conclude that there is no difference in the true variance in total serum cholesterol for urban residents of Guatemala compared to the variance for rural residents of Guatemala. Or, we can say the variances could be the same.
```{r}
plot(density(ratio4_sigma2), xlab=expression(sigma[urban]^2 - sigma[rural]^2), ylab='Density', main=expression(paste("Posterior distribution of ", sigma[urban]^2 - sigma[rural]^2, sep='')), xlim=c(0,15))


```


# 5.

```{r}
mu_urban_keep <- draws_2$mu[100:1e5]
sigma2_urban_keep <- draws_2$sigma2[100:1e5]
prob5_draws_urban <- rnorm(length(mu_urban_keep), mu_urban_keep, sqrt(sigma2_urban_keep))

plot(density(prob5_draws_urban), col='gray', ylab='Density', xlab=expression(Y[new]), ylim=c(0,0.035), main="Posterior Predictive Distributions")

mu_rural_keep <- draws_3$mu
sigma2_rural_keep <- draws_3$sigma2
prob5_draws_rural <- rnorm(length(mu_rural_keep), mu_rural_keep, sqrt(sigma2_rural_keep))
lines(density(prob5_draws_rural))
legend('topright', legend=c("Urban", "Rural"), lty=1, col=c("black","gray"))

```


\newpage

# Code
```{r Appendix 2, ref.label=knitr::all_labels(),echo=TRUE,eval=FALSE, include=TRUE}
```



